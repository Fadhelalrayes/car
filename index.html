<!doctype html>

<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>حالة الطقس</title>
<meta name="description" content="طقس الآن، الساعات القادمة، و5 أيام.">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet"><style>
  :root{ --bg:#fafafa; --card:#fff; --ink:#111; --muted:#6b7280; --border:#ece6cc; --shadow:0 8px 24px rgba(0,0,0,.06); --accent:linear-gradient(90deg,#d4af37,#ffdf7f);}  
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--ink); font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
  .wrap{max-width:900px; margin:auto; padding:16px; display:grid; gap:14px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); padding:14px}
  h1{margin:0; font-size:1.3rem; font-weight:800; background:var(--accent); -webkit-background-clip:text; background-clip:text; color:transparent}
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
  .loc{font-weight:800}
  .sub{color:var(--muted); font-size:.92rem}
  .now{display:flex; align-items:center; gap:12px}
  .now img{width:60px; height:60px}
  .now .t{font-size:2rem; font-weight:800}
  .grid{display:grid; gap:10px}
  @media(min-width:720px){ .grid{grid-template-columns:1fr 1fr} }
  .mini{display:grid; grid-template-columns:repeat(4,1fr); gap:8px}
  @media(max-width:480px){ .mini{grid-template-columns:repeat(2,1fr)} }
  .chip{border:1px solid var(--border); border-radius:12px; padding:10px; text-align:center}
  .chip .l{color:var(--muted); font-size:.86rem}
  .chip .v{font-weight:800}
  .secTitle{margin:0 0 10px; text-align:center; font-weight:800; background:var(--accent); -webkit-background-clip:text; background-clip:text; color:transparent}
  .hours, .days{display:grid; gap:8px; grid-template-columns:repeat(6,1fr)}
  @media(max-width:860px){ .hours{grid-template-columns:repeat(4,1fr)} .days{grid-template-columns:repeat(3,1fr)} }
  @media(max-width:520px){ .hours{grid-template-columns:repeat(3,1fr)} .days{grid-template-columns:repeat(2,1fr)} }
  .item{border:1px solid var(--border); border-radius:12px; padding:8px; text-align:center}
  .item img{width:36px; height:36px}
  .muted{color:var(--muted); font-size:.9rem}
  .err{color:#b91c1c; font-weight:700}
.top{justify-content:center; flex-direction:column; text-align:center}
</style></head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row top">
        <h1>حالة الطقس</h1>
        <div class="sub" id="dateLbl">—</div>
      </div>
    </div><div class="card">
  <div class="row">
    <div>
      <div class="loc" id="place">—</div>
      <div class="sub" id="tzLbl">—</div>
    </div>
    <div class="sub" id="upd">آخر تحديث —</div>
  </div>

  <div class="grid" style="margin-top:8px">
    <div class="now">
      <img id="iconNow" alt="" />
      <div>
        <div class="t" id="tNow">—°</div>
        <div id="condNow" class="muted">—</div>
      </div>
    </div>
    <div class="mini">
      <div class="chip"><div class="l">أعلى/أدنى</div><div class="v"><span id="hi">—</span>° / <span id="lo">—</span>°</div></div>
      <div class="chip"><div class="l">الرطوبة</div><div class="v"><span id="hum">—</span>%</div></div>
      <div class="chip"><div class="l">الرياح</div><div class="v"><span id="wind">—</span> كم/س</div></div>
      <div class="chip"><div class="l">الإحساس</div><div class="v"><span id="feels">—</span>°</div></div>
    </div>
  </div>

  <div class="chip" style="margin-top:12px; text-align:center;">
    <div class="l">أقرب وقت متوقع لسقوط المطر</div>
    <div class="v" id="nextRain">—</div>
  </div>

  <div class="sub err" id="msg" style="display:none"></div>
</div>

<div class="card">
  <h3 class="secTitle">الساعات القادمة</h3>
  <div id="hours" class="hours"></div>
</div>

<div class="card">
  <h3 class="secTitle">توقع 5 أيام</h3>
  <div id="days" class="days"></div>
</div>

  </div><script>
const OWM_KEY = "71679af819486daabc9848ad1dec6c05";

const qs = id=>document.getElementById(id);
const placeEl=qs('place'), tzEl=qs('tzLbl'), updEl=qs('upd'), iconNow=qs('iconNow');
const tNow=qs('tNow'), condNow=qs('condNow'), hiEl=qs('hi'), loEl=qs('lo');
const humEl=qs('hum'), windEl=qs('wind'), feelsEl=qs('feels');
const hoursEl=qs('hours'), daysEl=qs('days'), dateLbl=qs('dateLbl'), msgEl=qs('msg');
const nextRainEl=qs('nextRain');

const kmh = ms => Math.round(ms*3.6);
const fmtDateTime = (d) => d.toLocaleString('ar', { weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit'});
const fmtHour = (d) => d.toLocaleTimeString('ar', { hour:'2-digit', minute:'2-digit' });
const fromTZ = (ts, shift) => new Date((ts + shift) * 1000);

async function getCurrent(lat,lon){
  const u=`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OWM_KEY}&units=metric&lang=ar`;
  const r=await fetch(u); if(!r.ok) throw new Error('weather:'+r.status); return r.json();
}
async function getForecast(lat,lon){
  const u=`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${OWM_KEY}&units=metric&lang=ar`;
  const r=await fetch(u); if(!r.ok) throw new Error('forecast:'+r.status); return r.json();
}
async function reverseName(lat,lon){
  const u=`https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${OWM_KEY}`;
  const r=await fetch(u); if(!r.ok) throw new Error('geo:'+r.status); const j=await r.json(); return j?.[0];
}

function buildDays(list, tzShift){
  const byDay = {};
  list.forEach(ent=>{
    const d = fromTZ(ent.dt, tzShift);
    const dayKey = d.toISOString().slice(0,10);
    if(!byDay[dayKey]) byDay[dayKey] = [];
    byDay[dayKey].push(ent);
  });
  return Object.keys(byDay).sort().map(k=>{
    const arr = byDay[k];
    let tmax = -1e9, tmin = 1e9, icon = arr[0].weather[0].icon, desc = arr[0].weather[0].description;
    const mid = arr.find(e=>{ const h = fromTZ(e.dt, tzShift).getUTCHours(); return h>=11 && h<=15; }) || arr[0];
    arr.forEach(e=>{ tmax = Math.max(tmax, e.main.temp_max); tmin = Math.min(tmin, e.main.temp_min); });
    icon = mid.weather[0].icon; desc = mid.weather[0].description;
    return { tmax:Math.round(tmax), tmin:Math.round(tmin), icon, desc, dt:arr[0].dt };
  });
}

function fillNow(current, tzShift, place){
  const w=current.weather[0];
  placeEl.textContent = place || (current.name? `${current.name}، ${current.sys.country}` : "موقعك");
  tzEl.textContent = `المنطقة الزمنية: UTC${tzShift/3600}`;
  dateLbl.textContent = fmtDateTime(new Date());
  updEl.textContent = "آخر تحديث " + fmtDateTime(new Date());
  tNow.textContent = Math.round(current.main.temp) + "°";
  condNow.textContent = w.description;
  iconNow.src = `https://openweathermap.org/img/wn/${w.icon}@2x.png`;
  hiEl.textContent = Math.round(current.main.temp_max);
  loEl.textContent = Math.round(current.main.temp_min);
  humEl.textContent = Math.round(current.main.humidity);
  windEl.textContent = kmh(current.wind.speed);
  feelsEl.textContent = Math.round(current.main.feels_like);
}

function fillHours(list, tzShift){
  hoursEl.innerHTML = list.slice(0,6).map(ent=>{
    const d = fromTZ(ent.dt, tzShift);
    const w = ent.weather[0];
    const pop = Math.round((ent.pop||0)*100);
    return `<div class="item">
      <div class="muted">${fmtHour(d)}</div>
      <img src="https://openweathermap.org/img/wn/${w.icon}.png" alt="${w.description}">
      <div><strong>${Math.round(ent.main.temp)}°</strong></div>
      <div class="muted">${pop}%</div>
    </div>`;
  }).join("");
}

function fillDays(days, tzShift){
  daysEl.innerHTML = days.slice(0,5).map(d=>{
    const dn = new Date((d.dt+tzShift)*1000).toLocaleDateString('ar', { weekday:'short' });
    return `<div class="item">
      <div class="muted">${dn}</div>
      <img src="https://openweathermap.org/img/wn/${d.icon}.png" alt="${d.desc}">
      <div><strong>${d.tmax}°</strong> / <span class="muted">${d.tmin}°</span></div>
      <div class="muted">${d.desc}</div>
    </div>`;
  }).join("");
}

function findNextRain(list, tzShift){
  // ابحث أولاً عن أقرب فترة لديها مطر (rain) أو احتمال > 0%
  let candidate = list.find(ent => (ent.rain && (Object.values(ent.rain)[0]||0) > 0) || (ent.pop||0) > 0);
  // إن لم يوجد ضمن التسلسل، اختر الفترة ذات أعلى احتمال هطول كخيار بعيد
  if(!candidate){
    candidate = list.reduce((best, ent) => {
      const pop = ent.pop||0;
      const r = ent.rain ? (Object.values(ent.rain)[0]||0) : 0;
      const score = (r>0? 1:0) + pop; // أولوية للمطر الفعلي ثم الاحتمال
      if(!best) return ent;
      const bestPop = best.pop||0;
      const bestR = best.rain ? (Object.values(best.rain)[0]||0) : 0;
      const bestScore = (bestR>0?1:0) + bestPop;
      return score>bestScore ? ent : best;
    }, null);
  }
  if(candidate){
    const d = fromTZ(candidate.dt, tzShift);
    const popPct = Math.round((candidate.pop||0)*100);
    nextRainEl.textContent = `${fmtDateTime(d)} — احتمال ${popPct}%`;
  } else {
    nextRainEl.textContent = "لا توجد أمطار في البيانات المتاحة";
  }
}
}

function showError(text){
  msgEl.style.display='block';
  msgEl.textContent = text;
}

async function refresh(lat,lon){
  try{
    msgEl.style.display='none';
    const [cur, f5, rev] = await Promise.all([
      getCurrent(lat,lon),
      getForecast(lat,lon),
      reverseName(lat,lon).catch(()=>null)
    ]);
    const tzShift = cur.timezone || 0;
    const place = rev ? `${(rev.local_names&&rev.local_names.ar)||rev.name}، ${rev.country}` : (cur.name? `${cur.name}، ${cur.sys.country}` : 'موقعك');
    fillNow(cur, tzShift, place);
    fillHours(f5.list, tzShift);
    const days = buildDays(f5.list, tzShift);
    fillDays(days, tzShift);
    findNextRain(f5.list, tzShift);
  }catch(e){
    console.error(e);
    showError('تعذّر جلب البيانات');
    updEl.textContent = 'تعذّر جلب البيانات';
  }
}

(function init(){
  const fallback = ()=>refresh(26.2235,50.5876);
  if('geolocation' in navigator){
    navigator.geolocation.getCurrentPosition(
      pos=>refresh(pos.coords.latitude,pos.coords.longitude),
      ()=>fallback(),
      { enableHighAccuracy:false, timeout:8000, maximumAge:60000 }
    );
  } else {
    fallback();
  }
})();
</script></body>
</html>
