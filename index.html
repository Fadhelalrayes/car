# build_magazine.py
# يصنع مجلة PDF A4 احترافية بالعربية (غلاف + فهرس + 4 مقالات + صور + ذهبيات)
# المتطلبات: fpdf2, arabic-reshaper, python-bidi, pillow, requests
# الخطوط المقترحة بجانب السكريبت:
#   - NotoNaskhArabic-Regular.ttf  (نصوص)
#   - Cairo-Bold.ttf               (عناوين)
from fpdf import FPDF
from PIL import Image
import requests, io, os, textwrap
import arabic_reshaper
from bidi.algorithm import get_display

# ---------- إعدادات عامة ----------
A4_W, A4_H = 210, 297  # mm
MARGIN = 12            # mm
BODY_SIZE = 14
TITLE_SIZE = 22
SUB_SIZE = 12
GOLD = (182, 140, 43)  # ذهبي أنيق
INK  = (27, 27, 27)
TEAL = (10, 92, 85)

FONT_TEXT = "NotoNaskhArabic-Regular.ttf"
FONT_TITLE = "Cairo-Bold.ttf"

# صور
IMG_COVER = "https://almaaref.org/static/images/d64c8e140d07af8b34d63ecc32e4772d.jpg"
IMG_HAND  = "https://almaaref.org/static/images/3f3fc3d1ae67b79efaccd5783f2e91bc.jpg"

# ---------- أدوات مساعدة ----------
def ar(s: str) -> str:
    """تشكيل واتجاه نص عربي لعرض صحيح في PDF."""
    if not s:
        return ""
    return get_display(arabic_reshaper.reshape(s))

def mm(pdf: FPDF, x=None, y=None):
    """تحويل بسيط: لا حاجة الآن، مجرد تلميح مرجعي."""

def fetch_image(url: str) -> io.BytesIO:
    r = requests.get(url, timeout=30)
    r.raise_for_status()
    return io.BytesIO(r.content)

def add_fonts(pdf: FPDF):
    pdf.add_font("title", "", FONT_TITLE, uni=True)
    pdf.add_font("body", "", FONT_TEXT, uni=True)

def header_gold(pdf: FPDF, title_right: str, title_left: str = ""):
    """ترويسة ذهبية لكل صفحة داخلية"""
    pdf.set_fill_color(*GOLD)
    pdf.rect(0, 0, A4_W, 8, style="F")
    pdf.set_xy(MARGIN, 3)
    pdf.set_text_color(255, 255, 255)
    pdf.set_font("title", size=12)
    pdf.cell(0, 0, ar(title_left), align="L")
    pdf.set_xy(A4_W - MARGIN, 3)
    pdf.cell(0, 0, ar(title_right), align="R")
    pdf.set_text_color(*INK)

def footer_page_no(pdf: FPDF):
    pdf.set_y(-12)
    pdf.set_font("body", size=10)
    pdf.set_text_color(*GOLD)
    pdf.cell(0, 6, ar(f"ص {pdf.page_no()}"), 0, 0, "C")
    pdf.set_text_color(*INK)

def new_page(pdf: FPDF, header_right="", header_left=""):
    pdf.add_page()
    header_gold(pdf, header_right, header_left)
    pdf.set_auto_page_break(auto=True, margin=15)

def add_title(pdf: FPDF, title: str, subtitle: str = "", color=TEAL):
    pdf.ln(10)
    pdf.set_font("title", size=TITLE_SIZE)
    pdf.set_text_color(*color)
    pdf.cell(0, 9, ar(title), ln=1, align="R")
    if subtitle:
        pdf.set_font("body", size=SUB_SIZE)
        pdf.set_text_color(110, 106, 91)
        pdf.cell(0, 7, ar(subtitle), ln=1, align="R")
    pdf.set_text_color(*INK)
    pdf.ln(2)
    # خط فاصل ذهبي
    pdf.set_draw_color(*GOLD)
    pdf.set_line_width(0.6)
    pdf.line(MARGIN, pdf.get_y(), A4_W - MARGIN, pdf.get_y())
    pdf.ln(3)

def add_image_full(pdf: FPDF, img_bytes: io.BytesIO, max_h=120):
    """إدراج صورة عرض كامل المنطقة النصية مع الحفاظ على الأبعاد."""
    with Image.open(img_bytes) as im:
        w, h = im.size
    page_w = A4_W - 2*MARGIN
    # حساب الارتفاع المتاح
    target_w = page_w
    target_h = target_w * h / w
    if target_h > max_h:
        target_h = max_h
        target_w = target_h * w / h
    x = (A4_W - target_w) / 2
    pdf.image(img_bytes, x=x, y=pdf.get_y(), w=target_w, h=target_h)
    pdf.ln(target_h + 2)

def add_article(pdf: FPDF, title: str, image_url: str, paragraphs: list, section_label="باب"):
    """يبدأ المقال على صفحة جديدة وينساب في عمودين داخل كل صفحة."""
    new_page(pdf, header_right="مجلة المعرفة", header_left=section_label)
    add_title(pdf, title)
    # صورة المقال
    if image_url:
        add_image_full(pdf, fetch_image(image_url), max_h=95)

    # إعداد النص
    pdf.set_font("body", size=BODY_SIZE)
    col_gap = 7  # mm
    col_width = (A4_W - 2*MARGIN - col_gap) / 2
    left_x = MARGIN
    right_x = MARGIN + col_width + col_gap
    top_y = pdf.get_y()

    def write_paragraphs(pars):
        nonlocal top_y
        x, y = left_x, top_y
        col = 0  # 0=يسار (RTL منطقياً عمود أيمن بصرياً)، 1=يمين
        for p in pars:
            text = ar(p)
            # تقسيم إلى أسطر تناسب عرض العمود
            # fpdf2 يحسب تلقائياً مع multi_cell
            while text:
                pdf.set_xy((right_x if col else left_x), y)
                # نستخدم multi_cell لاتجاه RTL
                pdf.multi_cell(col_width, 7, text, align="R")
                new_y = pdf.get_y()
                # تأكد من عدم النزول تحت الهامش
                if new_y > (A4_H - 15):  # قريب من أسفل الصفحة
                    # عمود جديد أو صفحة جديدة
                    if col == 0:
                        # انتقل للعمود الثاني
                        col = 1
                        y = top_y
                    else:
                        # صفحة جديدة للمقال ذاته (لا خلط)
                        new_page(pdf, header_right="مجلة المعرفة", header_left=section_label)
                        pdf.set_font("body", size=BODY_SIZE)
                        # إعادة أعمدة الصفحة
                        top_y = pdf.get_y()
                        y = top_y
                        col = 0
                    # أعد كتابة الفقرة من البداية في الموضع الجديد
                else:
                    # انتقل لسطر التالي ضمن نفس العمود
                    y = new_y
                    break

    write_paragraphs(paragraphs)

def add_cover(pdf: FPDF):
    pdf.add_page()
    # خلفية ذهبية رقيقة
    pdf.set_fill_color(255, 248, 224)
    pdf.rect(0, 0, A4_W, A4_H, "F")
    # صورة الغلاف
    add_image_full(pdf, fetch_image(IMG_COVER), max_h=160)
    # عنوان الغلاف
    pdf.set_font("title", size=28)
    pdf.set_text_color(*GOLD)
    pdf.cell(0, 14, ar("مجلة المعرفة"), ln=1, align="C")
    pdf.set_font("body", size=14)
    pdf.set_text_color(80, 72, 55)
    pdf.cell(0, 10, ar("فصلية ثقافية تصدر عن مجلس الشيخ عباس الريس"), ln=1, align="C")
    pdf.cell(0, 8, ar("العدد الأول – ربيع الثاني 1447"), ln=1, align="C")
    pdf.set_text_color(*INK)

def add_toc(pdf: FPDF, items):
    new_page(pdf, header_right="فهرس المحتويات", header_left="TOC")
    add_title(pdf, "فهرس المحتويات", color=GOLD)
    pdf.set_font("body", size=14)
    for label, page in items:
        # سطر فهرس بنمط نقاط
        line = f"{label}"
        dots = " . " * max(3, 35 - len(label))
        entry = f"{line}{dots}{page}"
        pdf.cell(0, 8, ar(entry), ln=1, align="R")

# ---------- محتوى المجلة ----------
mag_title = "مجلة المعرفة"
mag_tag   = "فصلية ثقافية تصدر عن مجلس الشيخ عباس الريس"
edition   = "العدد الأول – ربيع الثاني 1447"

art1_title = "الأسرة في الإسلام: حصن يواجه العولمة"
art1_pars = [
"في زمن العولمة والاتصال المفتوح، تواجه أسرنا تحدياً وجودياً. ابتعاد عن القيم الإلهية يقابله غزو ثقافي غربي، يجعل بناء مناعة ذاتية ضرورة حتمية. فبدون جهوزية روحية، يصبح السقوط في متاهات الضلال أمراً محتوماً.",
"يساء فهم دائرة المسؤولية العائلية لدى الكثيرين. يعتقد البعض أن «الحلقة الأضيق» تقتصر على الزوجة والأبناء، مستبعدين الوالدين بعد استقلال الأبناء. هذا الفهم خاطئ جملة وتفصيلاً في الرؤية الإسلامية، التي تجعل للوالدين مكاناً أساسياً في قلب هذه الدائرة ومسؤوليتنا تجاههما دائمة.",
"تنطلق الرؤية الإسلامية من تربية الفرد كأصل لبناء أي مجتمع، وبناء الأسرة المتعاونة المتراحمة كخلية سليمة تُشكّل نسيج المجتمع القوي. من هنا جاءت التشريعات التي تحث على الزواج وتسهله، وتنظم شؤون الأسرة وتحافظ على كيانها.",
"ما نستورده من ثقافات عبر الشاشات ليس مثالاً يُحتذى. ففي المجتمعات الغربية، رغم تقدمها المادي، نرى مأساة إنسانية من ارتفاع مخيف في نسب الطلاق والعزوبية وتفكك الروابط الأسرية. هذا النموذج المأزوم هو ما يُسوَّق لنا، ويجب أن يكون جرس إنذار لنا جميعاً.",
"المواجهة لا تكون بالانغلاق، بل بالوعي والبناء من خلال تعزيز علاقتنا مع الله تعالى والتمسك بقيمنا الإسلامية الأصيلة في التربية والمسؤولية. الأسرة هي حصن الأمة، وحمايتها مسؤولية جماعية."
]

art2_title = "الصدق مع النفس والله: رحلة إلى القلب النقي"
art2_pars = [
"الصدق هو البوابة الأولى للإيمان الحقيقي. إنه الصراحة الكاملة مع الذات، والاعتراف بالعيوب دون تزييف، وتصحيح المسار بثبات. فمن لم يصدق مع نفسه، كيف يصدق مع غيره؟ وكيف ينال رضا ربه؟",
"يقول الإمام علي عليه السلام: «مَن عرف نفسه جاهدها، ومن جهل نفسه أهملها». بداية الطريق هي معرفة النفس، فهي المفتاح الذي يُحررنا من أغلال الجهل والضلال.",
"ثم تأتي الخطوة التالية: التمييز بين الخير والشر. فالحسنات من فضل الله، والسيئات من صنع أيدينا. هذه المعرفة تدفعنا للمحاسبة اليومية، وهي الوقود الذي يضيء طريق التوبة والرجوع إلى الله.",
"أما الصدق مع الله فهو جوهر العبادة. هو الإخلاص الذي يطهر النية من أي شائبة. أن تعمل لوجه الله فقط، لا لمراءاة الناس. يقول تعالى: «فَلَوْ صَدَقُوا اللَّهَ لَكَانَ خَيْرًا لَّهُمْ». إنه الوعد الإلهي: من يصدق مع ربه، ينل الخيرية في الدنيا والآخرة.",
"إن الصادقين هم من يوفون بعهدهم مع الله، حتى لو كانت التضحيات جسام. فهم القدوة في الإيمان والتضحية، وقد وصفهم القرآن بأنهم «أُوْلَئِكَ هُمُ الصَّادِقُونَ».",
"ليكن شعارنا: محاسبة دائمة، ونية خالصة، وصدق لا يتزعزع. فهذا هو طريق النجاة."
]

art3_title = "الخطر الخفي: عندما يخبو نور الإيمان"
art3_pars = [
"أخطر ما يهدد الإنسان هو العدو الداخلي. حين نستسلم للشهوات والأنانية، ونتخاذل عن محاربة الانحلال الأخلاقي في أنفسنا، فإننا نخاطر بفقدان أعظم نعمة: الإيمان.",
"لا يذهب الإيمان بين ليلة وضحاها، بل يتراجع شيئاً فشيئاً حتى يصبح القلب خالياً منه، بينما يظل المظهر إيمانياً. هذه الهوة بين الظاهر والباطن هي النفاق بعينه، وهو الخطر الأكبر على الفرد والأمة.",
"يحذرنا القرآن: «فَأَعْقَبَهُمْ نِفَاقًا فِي قُلُوبِهِمْ». عندما نخلد إلى الراحة ونتبع أهواءنا بدل أداء تكاليفنا، يصبح القلب مرتعاً للنفاق. العدو الخارجي قد يهزمك ولكنه لا يقتلع جذور الإيمان من القلب، أما العدو الداخلي – وهو ضعف النفس – فيفرغك من داخلك ويضلك عن الطريق.",
"العلاج يكمن في اليقظة الدائمة ومحاربة الهوى. حيثما حاربت أنانيتك وقدمت التكليف على هواك، تقدمت وانتصرت. وحيثما استسلمت للمنّ والتراخي، تكون الهزيمة من داخلك.",
"ليكن شعارنا: محاسبة دائمة، وجهاد متواصل ضد النفس الأمارة بالسوء. فهذا هو درع الوقاية من أسوأ العواقب: قلب خال من الإيمان."
]

art4_title = "الحياءُ شعاعٌ من نور الإيمان"
art4_pars = [
"ليس الحياء مجرد خُلق نبيل نتزين به في تعاملاتنا، بل هو جوهرٌ من جوهر الإيمان، وعلامة صادقة على الشعور الحقيقي بقرب الله تعالى ومراقبته. عن الرسول الأكرم صلى الله عليه وآله أنه قال: «استحيوا من الله حق الحياء». وهذا النداء النبوي يطرح سؤالاً مهماً: كيف نستحي من الله حق الحياء؟",
"إن الإجابة تكمن في وصية النبي صلى الله عليه وآله التي ترسم لنا خريطة الطريق العملي لهذا الحياء الحقيقي. فأول خطوات هذا الطريق أن تبيت كل ليلة وأجلك بين عينيك، متذكراً الموت ولحظة الرحيل، فهذا الذكر يضيء القلب ويصفي النية. ثم تأتي الخطوة الثانية وهي حفظ الرأس وما حوى، من عين تنظر بها، وأذن تسمع بها، ولسان تنطق به، فتحرسها عن كل ما يغضب الله.",
"ولا يقتصر الحياء على حفظ الجوارح الظاهرة، بل يمتد ليشمل الباطن أيضاً، فتحفظ بطنك عن الحرام حتى القليل منه، وتحرص على أن يكون طعامك وشرابك من الحلال الطيب. وتتذكر دائماً القبر والبلوى، فتترك زينة الحياة الدنيا وزخرفها عندما تعيقك عن طريق الآخرة.",
"إن العلاقة بين الحياء والإيمان علاقة وثيقة، فهما كالتوأم الذي لا يفترق. فكلما قوي شعورك بمراقبة الله تعالى، قوي حياؤك، وكلما غفلت عن وجود الملكين الكاتبين اللذين يرافقانك ليل نهار، ضعف حياؤك. وقد أوصى الأئمة عليهم السلام بأن نستحي من الله في السر كما نستحي من الناس في العلن.",
"هذا الحياء الحقيقي هو الذي يصنع القلب النقي والإيمان الثابت، وهو الدرع الواقي من الوقوع في المعاصي، والبوصلة التي ترشدنا إلى طريق الرضا الإلهي. فليكن حياؤنا من الله شمساً تنير دربنا، وتقربنا من رحمة ربنا."
]

# ---------- إنشاء PDF ----------
pdf = FPDF(orientation="P", unit="mm", format="A4")
pdf.set_auto_page_break(auto=False)
add_fonts(pdf)

# غلاف
add_cover(pdf)

# فهرس (سيظهر بدون أرقام صفحات دقيقة — نبدأ كل مقال في صفحة جديدة لتسهيل العثور عليه)
toc_items = [
    (art1_title, "—"),
    (art2_title, "—"),
    (art3_title, "—"),
    (art4_title, "—"),
]
add_toc(pdf, toc_items)

# المقالات (كل مقال يبدأ صفحة جديدة ولا يختلط بغيره)
add_article(pdf, art1_title, IMG_COVER, art1_pars, section_label="قضايا المجتمع")
add_article(pdf, art2_title, IMG_HAND, art2_pars, section_label="تزكية النفس")
add_article(pdf, art3_title, IMG_HAND, art3_pars, section_label="إيمانيات")
add_article(pdf, art4_title, IMG_COVER, art4_pars, section_label="الأخلاق")

# ترقيم الصفحات (تذييل)
for n in range(1, pdf.page_no()+1):
    pdf.page = n
    footer_page_no(pdf)

out_name = "مجلة-المعرفة-العدد-الأول.pdf"
pdf.output(out_name)
print(f"تم إنشاء الملف: {out_name}")
