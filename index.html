<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>مدار الخبر | متجددة لحظة بلحظة</title>
  <meta name="description" content="مدار الخبر — صفحة أخبار عربية متجددة لحظة بلحظة من عدة مصادر موثوقة، مع عرض سريع ودقيق.">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="canonical" href="https://example.com/">
  <link rel="alternate" hreflang="ar" href="https://example.com/">
  <meta name="robots" content="index,follow,max-image-preview:large">

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:locale" content="ar_AR">
  <meta property="og:title" content="مدار الخبر | متجددة لحظة لحظة">
  <meta property="og:description" content="متابعة آنية لأهم الأخبار العربية من مصادر موثوقة، تحدّث تلقائياً.">
  <meta property="og:url" content="https://example.com/">
  <meta property="og:image" content="https://example.com/cover.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="مدار الخبر | متجددة لحظة لحظة">
  <meta name="twitter:description" content="متابعة آنية لأهم الأخبار العربية من مصادر موثوقة.">
  <meta name="twitter:image" content="https://example.com/cover.jpg">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com" defer></script>

  <style>
    :root{--card-shadow:0 4px 14px rgba(0,0,0,.06)}
    body{
      font-family:'Cairo','Tajawal',system-ui,Arial,sans-serif;
      background:#f8fafc;color:#0f172a;line-height:1.9
    }
    .brand-title{letter-spacing:.2px}
    .clock{font-variant-numeric:tabular-nums}
    .btn{padding:.55rem .9rem;border-radius:12px;border:1px solid #e2e8f0;background:#fff;font-weight:700}
    .btn-brand{background:#0ea5e9;color:#fff;border-color:transparent}

    /* شريط إخباري (يظهر/يختفي حسب الأخبار) */
    .ticker-bar{display:none;background:#0ea5e9;color:#fff;border-bottom:1px solid rgba(255,255,255,.25)}
    .ticker-inner{display:flex;overflow:hidden;gap:2rem}
    .ticker-track{display:flex;gap:2rem;white-space:nowrap;animation:ticker 28s linear infinite}
    .ticker-item{opacity:.98}
    .ticker-item::before{content:"•";margin-inline:8px;opacity:.7}
    .ticker-bar:hover .ticker-track{animation-play-state:paused}
    @keyframes ticker{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

    /* بطاقات الأخبار — صورة كبيرة */
    .article{
      background:#fff;padding:18px;border-radius:16px;box-shadow:var(--card-shadow);
      display:grid;grid-template-columns:280px 1fr;gap:18px;cursor:pointer
    }
    .thumb{width:280px;height:180px;border-radius:16px;object-fit:cover;background:#e2e8f0;transition:transform .2s}
    .article:hover .thumb{transform:scale(1.01)}
    .article h3{font-size:1.18rem;font-weight:800;margin-bottom:6px}
    .article .meta{font-size:.8rem;color:#64748b}
    .article p{text-align:justify;font-size:.98rem;margin-top:6px;white-space:pre-line}
    @media (max-width:820px){
      .article{grid-template-columns:1fr}
      .thumb{width:100%;height:240px}
    }

    /* صفحة التفاصيل */
    #detailView{display:none}
    .hero-img{width:100%;max-height:460px;object-fit:cover;border-radius:18px;background:#e2e8f0}

    /* تحسين قابلية القراءة */
    .nice-text{letter-spacing:.1px}
    .nice-heading{letter-spacing:.3px}
  </style>

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"NewsMediaOrganization",
    "name":"مدار الخبر",
    "url":"https://example.com/",
    "logo":"https://example.com/logo.png"
  }
  </script>
</head>
<body>

<!-- HEADER -->
<header class="bg-white/90 backdrop-blur sticky top-0 z-[60] border-b border-slate-100">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div style="width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,#0ea5e9,#6366f1);box-shadow:0 6px 16px rgba(14,165,233,.35)"></div>
      <div class="brand-title">
        <div class="text-[26px] font-extrabold bg-gradient-to-r from-sky-500 to-indigo-500 text-transparent bg-clip-text nice-heading">مدار الخبر</div>
        <div class="text-xs text-slate-500 -mt-1">متجددة لحظة بلحظة</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <div class="clock text-sm px-2 py-1 rounded-lg bg-slate-100 text-slate-700" id="liveClock">--:--:--</div>
      <button id="refreshNow" class="btn" aria-label="تحديث الآن">تحديث الآن</button>
    </div>
  </div>
  <!-- TICKER (يظهر فقط عند وجود أخبار) -->
  <div id="tickerBar" class="ticker-bar">
    <div class="max-w-6xl mx-auto px-4 py-2">
      <div class="ticker-inner">
        <div class="ticker-track" id="tickerTrack" aria-live="polite"></div>
        <div class="ticker-track" id="tickerTrackClone" aria-hidden="true"></div>
      </div>
    </div>
  </div>
</header>

<!-- MAIN (قائمة) -->
<main class="max-w-6xl mx-auto px-4 py-6 nice-text" id="mainView">
  <div class="mb-4 text-[13px] text-sky-800 bg-sky-100 border border-sky-200 rounded-lg px-3 py-2">
    📡 يتم تحديث الأخبار تلقائيًا كل دقيقة
  </div>

  <div id="loadingMsg" class="rounded-xl border border-sky-200 bg-sky-50 p-4 text-sky-700 mb-5">
    ⌛ يجري الآن جلب الأخبار…
  </div>

  <div id="emptyState" class="hidden rounded-xl border border-slate-200 bg-white p-5 text-slate-600">
    لا توجد أخبار متاحة حاليًا. قد يكون هناك انقطاع مؤقت من المصادر.
    <div class="mt-3">
      <button id="tryAgain" class="btn btn-brand">حاول مجددًا</button>
    </div>
  </div>

  <div id="newsList" class="space-y-4" aria-live="polite"></div>

  <div class="flex justify-center mt-8">
    <button id="loadMore" class="px-5 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700 disabled:opacity-50 disabled:cursor-not-allowed">
      تحميل المزيد
    </button>
  </div>
</main>

<!-- DETAIL PAGE -->
<section class="max-w-3xl mx-auto px-4 py-6" id="detailView">
  <button id="backBtn" class="mb-5 btn" aria-label="رجوع">← رجوع</button>
  <article id="detailArticle" class="bg-white p-5 rounded-2xl shadow">
    <img id="detailImg" class="hero-img" alt="صورة الخبر" loading="lazy" referrerpolicy="no-referrer">
    <h1 id="detailTitle" class="text-2xl font-extrabold mt-4 nice-heading"></h1>
    <div id="detailMeta" class="text-xs text-slate-500 mt-1"></div>
    <p id="detailBody" class="mt-4 text-justify leading-8 nice-text"></p>
  </article>
</section>

<!-- FOOTER -->
<footer class="text-center py-10 text-sm text-slate-500">
  © <span id="year"></span> مدار الخبر — جميع الحقوق محفوظة.
</footer>
<div class="text-center text-xs opacity-80 -mt-6 mb-8">
  <span class="text-sky-700 font-semibold cursor-pointer" onclick="openWhatsApp()">برمجة و تطوير : فاضل الريس</span>
</div>

<script>
/* ===== إعدادات عامة ===== */
const FEEDS = [
  "https://feeds.bbci.co.uk/arabic/rss.xml",
  "https://www.france24.com/ar/rss",
  "https://arabic.cnn.com/rss",
  "https://arabic.rt.com/rss/"
];

// بروكسيات احتياط
const PROXIES = [
  u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
  u => `https://r.jina.ai/http://r.jina.ai/${encodeURIComponent(u)}`
];

const FETCH_TIMEOUT_MS = 9000;
const AUTO_REFRESH_MIN = 1;
const CACHE_TTL_MS = 60 * 1000;
const MAX_RETRIES = 2;

const state = { all: [], page: 0, pageSize: 10, map: new Map() };
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

/* ===== أدوات مساعدة ===== */
function stripHtml(h){ const d=document.createElement("div"); d.innerHTML=h; return (d.textContent||"").replace(/\s+/g,' ').trim(); }
function hasAr(t){ return /[\u0600-\u06FF]/.test(t||""); }
function fmt(t){ const d=new Date(t); if(isNaN(d))return""; return d.toLocaleString('ar-EG',{dateStyle:'medium',timeStyle:'short'}); }
function startClock(){ const el=$("#liveClock"); function tick(){el.textContent=new Date().toLocaleTimeString('ar-BH',{hour12:false});} tick(); setInterval(tick,1000); }
function openWhatsApp(){ const link="https://api.whatsapp.com/send/?phone=97333375858&type=phone_number&app_absent=0"; window.open(link,"_blank","noopener"); }
function escapeHTML(s){ return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }

/* ===== تطبيع التاريخ ===== */
function tryParseDate(el){
  const picks = ["pubDate","updated","published","dc\\:date","date"];
  for(const p of picks){
    const t = el.querySelector(p)?.textContent?.trim();
    if(t){ const d = Date.parse(t); if(!isNaN(d)) return new Date(d).toISOString(); }
  }
  return "";
}

/* ===== مصدر الخبر ===== */
function sourceNameFromDoc(doc, fallback){
  const ch = doc.querySelector("channel>title, feed>title");
  return (ch?.textContent?.trim()) || fallback || "";
}

/* ===== شبكة مع إعادة محاولات ===== */
async function fetchWithTimeout(url, timeoutMs=FETCH_TIMEOUT_MS){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const res = await fetch(url,{signal:ctrl.signal,cache:"no-store",redirect:"follow"});
    clearTimeout(t);
    if(!res.ok) throw new Error("bad status");
    return await res.text();
  }catch(e){ clearTimeout(t); throw e; }
}
async function getWithRetries(url){
  for(let attempt=0; attempt<=MAX_RETRIES; attempt++){
    try{ return await fetchWithTimeout(url); }catch(_){}
    for(const p of PROXIES){
      try{ return await fetchWithTimeout(p(url)); }catch(_){}
    }
  }
  throw new Error("failed after retries");
}

/* ===== استخراج الصور ===== */
function pickImageFromItem(el){
  const media = el.querySelector("media\\:content, content");
  const media2 = el.querySelector("media\\:thumbnail, thumbnail");
  const enc = el.querySelector("enclosure");
  let url = (media && (media.getAttribute("url")||media.textContent)) ||
            (media2 && (media2.getAttribute("url")||media2.textContent)) || "";
  if(!url && enc && /^image\\//i.test(enc.getAttribute("type")||"")) url = enc.getAttribute("url")||"";
  if(!url){
    const descHTML = (el.querySelector("content\\:encoded")?.textContent || el.querySelector("description")?.textContent || "");
    const m = descHTML && descHTML.match(/<img[^>]+src=["']([^"']+)["']/i);
    if(m) url = m[1];
  }
  return url || "";
}

/* ===== تنظيف رابط الخبر ===== */
function cleanUrl(u){
  try{
    const url = new URL(u);
    ["utm_source","utm_medium","utm_campaign","utm_term","utm_content","fbclid","gclid"].forEach(k=>url.searchParams.delete(k));
    return url.toString();
  }catch{return u||"";}
}

/* ===== تحليل RSS ===== */
function parseRSS(xmlText, srcUrl){
  const doc = new DOMParser().parseFromString(xmlText,"text/xml");
  const srcName = sourceNameFromDoc(doc, new URL(srcUrl).hostname.replace(/^www\\./,''));
  const nodes = Array.from(doc.querySelectorAll("item,entry"));
  const items = nodes.map((el, idx)=>{
    const title=(el.querySelector("title")?.textContent||"").trim();
    const rawDesc=(el.querySelector("content\\:encoded")?.textContent||
                   el.querySelector("description")?.textContent||
                   el.querySelector("summary")?.textContent||"").trim();
    const full=stripHtml(rawDesc);
    const time = tryParseDate(el);
    const link=(el.querySelector("link")?.getAttribute?.("href") || el.querySelector("link")?.textContent || "").trim();
    const img=pickImageFromItem(el);
    const linkClean = cleanUrl(link);
    return {
      id: `${linkClean || srcUrl}|${(title||"").slice(0,80)}|${time||idx}`,
      title, full, time, link: linkClean, img, source: srcName
    };
  }).filter(i=> (hasAr(i.title)||hasAr(i.full)));
  return items;
}

/* ===== كاش محلي ===== */
function cacheGet(key){
  try{
    const s=localStorage.getItem(key);
    if(!s) return null;
    const obj=JSON.parse(s);
    if(Date.now()-obj.t > CACHE_TTL_MS) return null;
    return obj.v;
  }catch{return null;}
}
function cacheSet(key, value){ try{ localStorage.setItem(key, JSON.stringify({t:Date.now(), v:value})); }catch{} }

/* ===== شريط إخباري (إظهار/إخفاء) ===== */
function updateTicker(items){
  const bar = $("#tickerBar");
  const titles = items.slice(0,30).map(i=>escapeHTML(i.title||"")).filter(Boolean);
  const track = $("#tickerTrack");
  const clone = $("#tickerTrackClone");

  if(!titles.length){
    track.innerHTML = "";
    clone.innerHTML = "";
    bar.style.display = "none";        // إخفاء الشريط عند عدم وجود أخبار
    return;
  }
  const html = titles.map(t=>`<span class="ticker-item">${t}</span>`).join("");
  track.innerHTML = html;
  clone.innerHTML = html;
  bar.style.display = "block";         // إظهار الشريط عند وجود أخبار
}

/* ===== تحميل كل المصادر ===== */
async function loadAll(){
  $("#loadingMsg").classList.remove("hidden");
  $("#emptyState").classList.add("hidden");

  const cached = cacheGet("feeds-cache");
  if(cached){
    applyItems(cached);
    $("#loadingMsg").classList.add("hidden");
  }

  try{
    const results = await Promise.allSettled(FEEDS.map(async f => {
      const txt = await getWithRetries(f);
      return {f,txt};
    }));
    let all=[];
    for(const r of results){
      if(r.status==="fulfilled"){
        try{ all = all.concat(parseRSS(r.value.txt, r.value.f)); }
        catch(e){ console.warn("parse fail:", e); }
      }
    }
    // إزالة التكرار: بالأولوية للرابط ثم (العنوان + الوقت)
    const seen=new Set(), uniq=[];
    for(const it of all){
      const key = (it.link||"") || ((it.title||"")+"|"+(it.time||""));
      if(seen.has(key)) continue;
      seen.add(key);
      uniq.push(it);
    }
    // ترتيب زمني
    uniq.sort((a,b)=>(Date.parse(b.time)||0)-(Date.parse(a.time)||0));

    cacheSet("feeds-cache", uniq);
    applyItems(uniq);
  }catch(e){
    console.warn(e);
  }finally{
    $("#loadingMsg").classList.add("hidden");
    if(!state.all.length){
      $("#emptyState").classList.remove("hidden");
    }
  }
}

/* ===== تقديم العناصر + Lazy Images ===== */
function excerpt(txt, limit=240){return (txt||"").length<=limit?txt:txt.slice(0,limit)+"…";}

function articleHTML(a){
  const timeHtml = a.time? fmt(a.time):"";
  const img = a.img || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='280' height='180'%3E%3Crect width='100%25' height='100%25' fill='%23e2e8f0'/%3E%3C/svg%3E";
  return `
  <article class="article" data-id="${encodeURIComponent(a.id)}" role="button" tabindex="0" aria-label="فتح تفاصيل الخبر">
    <img class="thumb lazy" data-src="${encodeURIComponent(img)}" alt="صورة الخبر" referrerpolicy="no-referrer" loading="lazy">
    <div>
      <h3>${escapeHTML(a.title||"")}</h3>
      <div class="meta">${escapeHTML(a.source||"")}${a.source&&timeHtml?' · ':''}${timeHtml}</div>
      <p>${escapeHTML(excerpt(a.full||""))}</p>
    </div>
  </article>`;
}

function applyItems(items){
  state.all = items;
  state.page = 0;
  state.map.clear();
  for(const it of items){ state.map.set(it.id, it); }
  renderChunk(true);
  setupLazyImages();
  updateTicker(items);  // ← هنا يتم إظهار/إخفاء الشريط تلقائيًا
}

function renderChunk(reset){
  if(reset) $("#newsList").innerHTML="";
  const end = Math.min((state.page+1)*state.pageSize, state.all.length);
  const container = document.createElement("div");
  container.innerHTML = state.all.slice(0,end).map(articleHTML).join("");
  $("#newsList").replaceChildren(...Array.from(container.childNodes));
  $("#loadMore").disabled = end >= state.all.length;
}

/* ===== Lazy Loading ===== */
let io=null;
function setupLazyImages(){
  if(io) io.disconnect();
  io = new IntersectionObserver(entries=>{
    for(const e of entries){
      if(e.isIntersecting){
        const img=e.target;
        const src=decodeURIComponent(img.getAttribute("data-src")||"");
        if(src){ img.src = src; img.removeAttribute("data-src"); }
        io.unobserve(img);
      }
    }
  }, {rootMargin:"200px"});
  $$(".lazy").forEach(img=>io.observe(img));
}

/* ===== صفحة التفاصيل داخل الموقع ===== */
function openDetail(id){
  const a = state.map.get(id);
  if(!a) return;
  $("#detailImg").src = a.img || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='600'%3E%3Crect width='100%25' height='100%25' fill='%23e2e8f0'/%3E%3C/svg%3E";
  $("#detailTitle").textContent = a.title || "";
  $("#detailMeta").textContent = [a.source||"", a.time?fmt(a.time):""].filter(Boolean).join(" · ");
  $("#detailBody").textContent = a.full || "";

  injectDetailJsonLd(a);

  $("#mainView").style.display="none";
  $("#detailView").style.display="block";
  document.title = (a.title||"") + " | مدار الخبر";
  history.pushState({id}, "", `?id=${encodeURIComponent(id)}`);
  window.scrollTo({top:0, behavior:"instant"});
}

/* JSON-LD ديناميكي للخبر */
function injectDetailJsonLd(a){
  const old = document.getElementById("ld-article"); if(old) old.remove();
  const data = {
    "@context":"https://schema.org",
    "@type":"NewsArticle",
    "headline": a.title || "",
    "datePublished": a.time || "",
    "image": a.img ? [a.img] : undefined,
    "articleSection": "أخبار",
    "publisher": {"@type":"Organization","name":"مدار الخبر"},
    "mainEntityOfPage": {"@type":"WebPage","@id": location.href}
  };
  const s=document.createElement("script");
  s.type="application/ld+json"; s.id="ld-article";
  s.textContent = JSON.stringify(data);
  document.head.appendChild(s);
}

function goHome(push=true){
  $("#detailView").style.display="none";
  $("#mainView").style.display="block";
  document.title = "مدار الخبر | متجددة لحظة بلحظة";
  if(push) history.pushState({}, "", location.pathname);
}

/* ===== تفاعلات ===== */
document.addEventListener("click", e=>{
  const art=e.target.closest(".article");
  if(art){
    const id=decodeURIComponent(art.getAttribute("data-id")||"");
    openDetail(id);
  }
});
document.addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    const art=e.target.closest(".article");
    if(art){
      const id=decodeURIComponent(art.getAttribute("data-id")||"");
      openDetail(id);
    }
  }
});

$("#backBtn").onclick=()=>goHome();
window.addEventListener("popstate", ()=>{
  const params=new URLSearchParams(location.search);
  const id=params.get("id");
  if(id && state.map.has(id)) openDetail(id);
  else goHome(false);
});

$("#loadMore").onclick=()=>{state.page++; renderChunk(false); setupLazyImages();};
$("#refreshNow").onclick=()=>{loadAll();};
$("#tryAgain").onclick=()=>{loadAll();};
$("#year").textContent=new Date().getFullYear();

/* ===== إقلاع وتحديث ===== */
function boot(){
  startClock();
  loadAll();
  setInterval(loadAll, AUTO_REFRESH_MIN*60*1000);

  const params=new URLSearchParams(location.search);
  const id=params.get("id");
  if(id){
    const iv=setInterval(()=>{ if(state.map.size){ clearInterval(iv); if(state.map.has(id)) openDetail(id);} },200);
    setTimeout(()=>clearInterval(iv), 5000);
  }
}
boot();
</script>
</body>
</html>
